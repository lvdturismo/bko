<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LVD Turismo - Backoffice</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- jsPDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- Firebase SDKs (Modular) -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDocs, query, orderBy, updateDoc, doc, setDoc, getDoc, where, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // --- CONFIGURAÇÃO DO FIREBASE (PRODUÇÃO) ---
        const firebaseConfig = {
            apiKey: "AIzaSyCP3p2xPZ-jCY7Oz5Qu3hjRGt2UtiXRlf0",
            authDomain: "lvd-bko.firebaseapp.com",
            projectId: "lvd-bko",
            storageBucket: "lvd-bko.firebasestorage.app",
            messagingSenderId: "579882350468",
            appId: "1:579882350468:web:91d2699847462936f10fd1",
            measurementId: "G-THQC48E6V4"
        };

        // Inicialização Direta
        let app, auth, db;
        try {
            app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            console.log("Firebase inicializado.");
        } catch (e) {
            console.error("Erro Firebase:", e);
        }

        window.firebaseData = { auth, db, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence, collection, addDoc, getDocs, query, orderBy, updateDoc, doc, setDoc, getDoc, deleteDoc };
    </script>

    <style>
        body { font-family: 'Inter', sans-serif; background-color: #0f172a; color: #e2e8f0; }
        .sidebar-item { transition: all 0.2s; }
        .sidebar-item:hover { background-color: #1e293b; transform: translateX(5px); } 
        .hide-scroll::-webkit-scrollbar { display: none; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #475569; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-fade-in { animation: fadeIn 0.3s ease-in-out; }
        .modal-overlay { background-color: rgba(0, 0, 0, 0.75); }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        const { createRoot } = ReactDOM;

        // --- HELPER PARA ÍCONES ---
        const Icon = ({ name, className }) => {
            const wrapperRef = useRef(null);
            useEffect(() => {
                if (window.lucide && wrapperRef.current) {
                    try {
                        window.lucide.createIcons({
                            root: wrapperRef.current,
                            nameAttr: 'data-lucide',
                            attrs: { class: className }
                        });
                    } catch (e) { console.warn("Erro ícone:", name); }
                }
            }, [name, className]);
            return <span ref={wrapperRef} className="contents"><i key={name} data-lucide={name} className={className}></i></span>;
        };

        // --- COMPONENTES UI ---
        const Card = ({ children, className = "" }) => (
            <div className={`bg-slate-800 border border-slate-700 rounded-lg shadow-xl p-6 ${className}`}>{children}</div>
        );

        const Button = ({ children, onClick, variant = "primary", className = "", disabled=false }) => {
            const baseClass = "px-4 py-3 rounded-lg font-bold transition duration-200 flex items-center justify-center gap-2 shadow-lg disabled:opacity-50 disabled:cursor-not-allowed select-none";
            const variants = {
                primary: "bg-blue-600 text-white hover:bg-blue-500 active:scale-95",
                secondary: "bg-slate-700 text-slate-200 hover:bg-slate-600 border border-slate-600 active:scale-95",
                danger: "bg-red-600 text-white hover:bg-red-500 active:scale-95",
                warning: "bg-amber-500 text-black hover:bg-amber-400 active:scale-95",
                success: "bg-emerald-600 text-white hover:bg-emerald-500 active:scale-95"
            };
            return (
                <button onClick={onClick} className={`${baseClass} ${variants[variant]} ${className}`} disabled={disabled}>
                    {children}
                </button>
            );
        };

        const Input = ({ label, type = "text", value, onChange, placeholder, required = false, readOnly = false, name }) => (
            <div className="mb-4">
                <label className="block text-sm font-medium text-slate-300 mb-1">{label}</label>
                <input 
                    name={name}
                    type={type} 
                    value={value} 
                    onChange={onChange} 
                    className={`w-full p-3 bg-slate-700 border border-slate-600 text-white rounded-lg focus:ring-2 focus:ring-blue-500 focus:outline-none placeholder-slate-400 ${readOnly ? 'opacity-60 cursor-not-allowed' : ''}`}
                    placeholder={placeholder}
                    required={required}
                    readOnly={readOnly}
                />
            </div>
        );

        // --- UTILITÁRIOS ---
        const formatMoney = (val) => new Intl.NumberFormat('pt-BR', { style: 'currency', currency: 'BRL' }).format(val);
        const formatDate = (dateStr) => {
            if (!dateStr) return "-";
            const [y, m, d] = dateStr.split('-');
            return `${d}/${m}/${y}`;
        };
        const parseDateBR = (dateStr) => {
             const [y, m, d] = dateStr.split('-');
             return new Date(y, m - 1, d);
        }

        // --- PDF LOGIC ---
        const generateContractPDF = (contract, templateText) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const fullText = templateText
                .replace(/{{NOME}}/g, contract.clientName).replace(/{{CPF}}/g, contract.clientCpf)
                .replace(/{{DESTINO}}/g, contract.destination).replace(/{{ORIGEM}}/g, contract.origin)
                .replace(/{{DATA_IDA}}/g, formatDate(contract.startDate)).replace(/{{DATA_VOLTA}}/g, formatDate(contract.endDate))
                .replace(/{{VALOR_TOTAL}}/g, formatMoney(contract.totalValue)).replace(/{{SINAL}}/g, formatMoney(contract.signalValue))
                .replace(/{{CONTRATO_ID}}/g, contract.contractId);

            doc.setFontSize(18);
            doc.text(`Contrato de Locação - ${contract.contractId}`, 105, 20, null, null, "center");
            doc.setFontSize(12);
            doc.text(doc.splitTextToSize(fullText, 180), 15, 40);
            doc.line(15, 270, 195, 270);
            doc.setFontSize(10);
            doc.text("LVD Turismo - Transporte com Segurança e Qualidade", 105, 275, null, null, "center");
            doc.save(`Contrato_${contract.contractId}.pdf`);
        };

        const generateReceiptPDF = (contract, type, amount) => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF({ format: 'a5', orientation: 'landscape' });
            doc.setFontSize(22); doc.setTextColor(41, 128, 185); doc.text("LVD TURISMO", 105, 20, null, null, "center");
            doc.setFontSize(16); doc.setTextColor(0, 0, 0); doc.text("RECIBO DE PAGAMENTO", 105, 35, null, null, "center");
            doc.setFontSize(12);
            doc.text(`Recibemos de: ${contract.clientName}`, 20, 55); doc.text(`CPF: ${contract.clientCpf}`, 20, 65);
            doc.text(`A quantia de: ${formatMoney(amount)}`, 20, 75);
            doc.text(`Referente a: ${type === 'signal' ? 'Sinal/Entrada' : 'Pagamento Restante'} do Contrato ${contract.contractId}`, 20, 85);
            doc.text(`Destino: ${contract.destination}`, 20, 95);
            const today = new Date(); doc.text(`Data do Pagamento: ${today.toLocaleDateString('pt-BR')}`, 20, 115);
            doc.setLineWidth(0.5); doc.line(20, 135, 100, 135); doc.setFontSize(10); doc.text("Assinatura LVD Turismo", 60, 140, null, null, "center");
            doc.save(`Recibo_${contract.contractId}_${type}.pdf`);
        };

        // --- COMPONENTES DE TELA ---

        const ContractDetailsModal = ({ contract, onClose, onCancel }) => {
            if (!contract) return null;
            return (
                <div className="fixed inset-0 z-50 flex items-center justify-center p-4 modal-overlay animate-fade-in">
                    <Card className="w-full max-w-lg relative bg-slate-800 border border-slate-600 max-h-[90vh] overflow-y-auto">
                        <button onClick={onClose} className="absolute top-4 right-4 text-slate-400 hover:text-white"><Icon name="x" /></button>
                        
                        <h2 className="text-2xl font-bold mb-1 text-white">{contract.destination}</h2>
                        <p className="text-blue-400 text-sm mb-6 font-bold">{contract.contractId} - {contract.clientName}</p>

                        <div className="space-y-4">
                            <div className="bg-slate-700/50 p-3 rounded">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-2">Detalhes da Viagem</h3>
                                <p className="text-white"><span className="text-slate-400">Ida:</span> {formatDate(contract.startDate)}</p>
                                <p className="text-white"><span className="text-slate-400">Volta:</span> {formatDate(contract.endDate)}</p>
                                <p className="text-white"><span className="text-slate-400">Embarque:</span> {contract.origin}</p>
                            </div>

                            <div className="bg-slate-700/50 p-3 rounded">
                                <h3 className="text-xs font-bold text-slate-400 uppercase mb-2">Financeiro</h3>
                                <div className="grid grid-cols-2 gap-2 text-sm">
                                    <div>
                                        <span className="block text-slate-400">Total</span>
                                        <span className="font-mono text-emerald-400 font-bold">{formatMoney(contract.totalValue)}</span>
                                    </div>
                                    <div>
                                        <span className="block text-slate-400">Status Sinal</span>
                                        <span className={contract.statusSignal === 'paid' ? "text-emerald-400" : "text-amber-400"}>{contract.statusSignal === 'paid' ? 'Pago' : 'Pendente'}</span>
                                    </div>
                                </div>
                            </div>

                            {contract.status === 'cancelled' ? (
                                <div className="bg-red-900/50 border border-red-800 p-3 rounded text-center text-red-200 font-bold">
                                    CONTRATO CANCELADO
                                </div>
                            ) : (
                                <div className="pt-4 border-t border-slate-700">
                                    <Button variant="danger" className="w-full" onClick={() => onCancel(contract.id)}>
                                        <Icon name="x-circle" className="mr-2" /> Cancelar Contrato
                                    </Button>
                                    <p className="text-center text-xs text-slate-500 mt-2">Isso liberará as datas no calendário.</p>
                                </div>
                            )}
                        </div>
                    </Card>
                </div>
            );
        };

        const Sidebar = ({ view, setView, handleLogout }) => (
            <div className="w-20 md:w-64 bg-[#1e293b] border-r border-slate-700 text-slate-200 min-h-screen flex flex-col fixed left-0 top-0 z-40 shadow-xl transition-all">
                <div className="p-4 md:p-6 flex justify-center md:justify-start">
                        <div className="font-bold text-xl md:text-2xl tracking-wider text-blue-400">LVD <span className="hidden md:inline text-white">ADMIN</span></div>
                </div>
                <nav className="flex-1 mt-2 space-y-1">
                    {[
                        { id: 'home', icon: 'home', label: 'Início' },
                        { id: 'new_contract', icon: 'file-plus', label: 'Novo Contrato' },
                        { id: 'contracts', icon: 'file-text', label: 'Contratos' },
                        { id: 'calendar', icon: 'calendar', label: 'Calendário' },
                        { id: 'maintenance', icon: 'wrench', label: 'Manutenção' },
                        { id: 'finance', icon: 'dollar-sign', label: 'Financeiro' },
                        { id: 'settings', icon: 'settings', label: 'Configurações' },
                    ].map(item => (
                        <div key={item.id} onClick={() => setView(item.id)} className={`sidebar-item flex items-center px-4 py-4 cursor-pointer border-l-4 ${view === item.id ? 'bg-slate-800 border-blue-500 text-white' : 'border-transparent hover:text-white text-slate-400'}`} title={item.label}>
                            <Icon name={item.icon} className={`w-6 h-6 md:mr-3 ${view === item.id ? 'text-blue-400' : ''}`} />
                            <span className="hidden md:inline">{item.label}</span>
                        </div>
                    ))}
                </nav>
                <div className="p-4 border-t border-slate-700 bg-slate-800/50">
                    <button onClick={handleLogout} className="flex items-center justify-center md:justify-start text-slate-400 hover:text-red-400 transition w-full">
                        <Icon name="log-out" className="w-5 h-5 md:mr-2" />
                        <span className="hidden md:inline">Sair</span>
                    </button>
                </div>
            </div>
        );

        const HomeView = ({ setView }) => {
            const buttons = [
                { id: 'new_contract', icon: 'file-plus', label: 'Novo Contrato', color: 'bg-blue-600 hover:bg-blue-500' },
                { id: 'calendar', icon: 'calendar', label: 'Calendário', color: 'bg-indigo-600 hover:bg-indigo-500' },
                { id: 'finance', icon: 'dollar-sign', label: 'Financeiro', color: 'bg-emerald-600 hover:bg-emerald-500' },
                { id: 'maintenance', icon: 'wrench', label: 'Manutenções', color: 'bg-amber-600 hover:bg-amber-500' },
                { id: 'contracts', icon: 'file-text', label: 'Ver Contratos', color: 'bg-slate-700 hover:bg-slate-600' },
                { id: 'settings', icon: 'settings', label: 'Configurações', color: 'bg-slate-700 hover:bg-slate-600' },
            ];
            return (
                <div className="animate-fade-in">
                    <h2 className="text-2xl font-bold mb-6 text-white">Acesso Rápido</h2>
                    <div className="grid grid-cols-2 md:grid-cols-3 gap-4 md:gap-6">
                        {buttons.map(btn => (
                            <button key={btn.id} onClick={() => setView(btn.id)} className={`${btn.color} text-white p-6 rounded-xl shadow-lg flex flex-col items-center justify-center gap-3 transition transform active:scale-95 h-32 md:h-40`}>
                                <Icon name={btn.icon} className="w-8 h-8 md:w-10 md:h-10" />
                                <span className="font-bold text-sm md:text-lg">{btn.label}</span>
                            </button>
                        ))}
                    </div>
                </div>
            );
        };

        const NewContractView = ({ newContract, setNewContract, handleCreateContract, loading, configSignal }) => {
            const handleTotalChange = (val) => {
                const total = parseFloat(val) || 0;
                const signal = total * (configSignal / 100);
                setNewContract(prev => ({ ...prev, totalValue: val, signalValue: signal, remainingValue: total - signal }));
            };
            return (
                <Card className="animate-fade-in">
                    <h2 className="text-xl font-bold mb-6 flex items-center text-blue-400"><Icon name="file-plus" className="mr-2" /> Novo Contrato</h2>
                    <form onSubmit={handleCreateContract} className="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div className="md:col-span-2"><h3 className="font-bold text-slate-500 border-b border-slate-700 pb-2 mb-2 uppercase text-xs tracking-wide">Dados do Cliente</h3></div>
                        <Input label="Nome Completo" value={newContract.clientName} onChange={e => setNewContract({...newContract, clientName: e.target.value})} required />
                        <Input label="CPF" value={newContract.clientCpf} onChange={e => setNewContract({...newContract, clientCpf: e.target.value})} required placeholder="000.000.000-00" />
                        <div className="md:col-span-2"><h3 className="font-bold text-slate-500 border-b border-slate-700 pb-2 mb-2 mt-2 uppercase text-xs tracking-wide">Dados da Viagem</h3></div>
                        <Input label="Local de Embarque" value={newContract.origin} onChange={e => setNewContract({...newContract, origin: e.target.value})} required />
                        <Input label="Destino" value={newContract.destination} onChange={e => setNewContract({...newContract, destination: e.target.value})} required />
                        <Input label="Data Ida" type="date" value={newContract.startDate} onChange={e => setNewContract({...newContract, startDate: e.target.value})} required />
                        <Input label="Data Volta" type="date" value={newContract.endDate} onChange={e => setNewContract({...newContract, endDate: e.target.value})} required />
                        <div className="md:col-span-2"><h3 className="font-bold text-slate-500 border-b border-slate-700 pb-2 mb-2 mt-2 uppercase text-xs tracking-wide">Financeiro (Editável)</h3></div>
                        <Input label="Valor Total (R$)" type="number" value={newContract.totalValue} onChange={e => handleTotalChange(e.target.value)} required />
                        <div className="grid grid-cols-2 gap-4 md:col-span-2">
                            <Input label={`Valor Sinal (${configSignal}%)`} type="number" value={newContract.signalValue} onChange={e => setNewContract({...newContract, signalValue: e.target.value, remainingValue: newContract.totalValue - e.target.value})} required />
                            <Input label="Data Venc. Sinal" type="date" value={newContract.dueSignalDate || new Date().toISOString().split('T')[0]} onChange={e => setNewContract({...newContract, dueSignalDate: e.target.value})} required />
                        </div>
                        <div className="grid grid-cols-2 gap-4 md:col-span-2">
                            <Input label="Valor Restante" type="number" value={newContract.remainingValue} onChange={e => setNewContract({...newContract, remainingValue: e.target.value})} required />
                            <Input label="Data Venc. Restante" type="date" value={newContract.dueRestDate} onChange={e => setNewContract({...newContract, dueRestDate: e.target.value})} required />
                        </div>
                        <div className="md:col-span-2 pt-4">
                            <Button className="w-full text-lg shadow-blue-900/50" disabled={loading}>{loading ? "Salvando..." : "Gerar Contrato"}</Button>
                        </div>
                    </form>
                </Card>
            );
        };

        const MaintenanceView = ({ maintenances, handleCreateMaintenance, deleteMaintenance, loading }) => {
            const [newMaint, setNewMaint] = useState({ desc: '', startDate: '', endDate: '' });
            const onSubmit = (e) => { e.preventDefault(); handleCreateMaintenance(newMaint); setNewMaint({ desc: '', startDate: '', endDate: '' }); };
            return (
                <div className="space-y-6 animate-fade-in">
                    <Card>
                        <h2 className="text-xl font-bold mb-4 text-amber-500 flex items-center"><Icon name="wrench" className="mr-2" /> Agendar Manutenção</h2>
                        <form onSubmit={onSubmit} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                            <div className="md:col-span-2"><Input label="Descrição" value={newMaint.desc} onChange={e => setNewMaint({...newMaint, desc: e.target.value})} required placeholder="Ex: Troca de óleo" /></div>
                            <Input label="Início" type="date" value={newMaint.startDate} onChange={e => setNewMaint({...newMaint, startDate: e.target.value})} required />
                            <Input label="Fim" type="date" value={newMaint.endDate} onChange={e => setNewMaint({...newMaint, endDate: e.target.value})} required />
                            <div className="md:col-span-4"><Button variant="warning" className="w-full" disabled={loading}>{loading ? "..." : "Agendar"}</Button></div>
                        </form>
                    </Card>
                    <Card>
                        <h3 className="font-bold mb-4 text-slate-300">Manutenções Programadas</h3>
                        <div className="space-y-3">
                            {maintenances.map(m => (
                                <div key={m.id} className="flex justify-between items-center bg-slate-700/50 p-3 rounded border border-slate-600">
                                    <div><div className="font-bold text-white">{m.desc}</div><div className="text-sm text-slate-400">{formatDate(m.startDate)} até {formatDate(m.endDate)}</div></div>
                                    <Button variant="danger" className="py-1 px-3 text-xs" onClick={() => deleteMaintenance(m.id)}><Icon name="trash-2" className="w-4 h-4" /></Button>
                                </div>
                            ))}
                            {maintenances.length === 0 && <p className="text-slate-500">Nenhuma manutenção.</p>}
                        </div>
                    </Card>
                </div>
            );
        };

        const CalendarView = ({ contracts, maintenances, onEventClick }) => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const daysInMonth = new Date(currentDate.getFullYear(), currentDate.getMonth() + 1, 0).getDate();
            const firstDayOfMonth = new Date(currentDate.getFullYear(), currentDate.getMonth(), 1).getDay();
            const days = Array.from({ length: daysInMonth }, (_, i) => i + 1);
            const empties = Array.from({ length: firstDayOfMonth }, (_, i) => i);
            const monthName = currentDate.toLocaleString('pt-BR', { month: 'long', year: 'numeric' });

            const checkEvent = (day) => {
                const dateStr = `${currentDate.getFullYear()}-${String(currentDate.getMonth() + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                const evts = [];
                // Only showing Active contracts
                contracts.filter(c => c.status !== 'cancelled').forEach(c => {
                    if (dateStr >= c.startDate && dateStr <= c.endDate) {
                        evts.push({ type: 'contract', title: c.destination, color: 'bg-blue-600', data: c });
                    }
                });
                maintenances.forEach(m => {
                    if (dateStr >= m.startDate && dateStr <= m.endDate) {
                        evts.push({ type: 'maint', title: m.desc, color: 'bg-red-600', data: null });
                    }
                });
                return evts;
            };

            const changeMonth = (offset) => setCurrentDate(new Date(currentDate.setMonth(currentDate.getMonth() + offset)));

            return (
                <Card className="animate-fade-in">
                    <div className="flex justify-between items-center mb-6">
                        <button onClick={() => changeMonth(-1)} className="p-2 bg-slate-700 rounded hover:bg-slate-600"><Icon name="chevron-left" /></button>
                        <h2 className="text-xl font-bold capitalize text-white">{monthName}</h2>
                        <button onClick={() => changeMonth(1)} className="p-2 bg-slate-700 rounded hover:bg-slate-600"><Icon name="chevron-right" /></button>
                    </div>
                    <div className="grid grid-cols-7 gap-1 md:gap-2">
                        {['Dom', 'Seg', 'Ter', 'Qua', 'Qui', 'Sex', 'Sáb'].map(d => <div key={d} className="text-center font-bold text-slate-500 text-xs md:text-sm py-2">{d}</div>)}
                        {empties.map(e => <div key={`empty-${e}`} className="bg-transparent"></div>)}
                        {days.map(day => {
                            const events = checkEvent(day);
                            return (
                                <div key={day} className="bg-slate-900/50 border border-slate-700 min-h-[80px] p-1 rounded relative overflow-hidden">
                                    <span className="text-slate-400 text-sm font-bold absolute top-1 right-2">{day}</span>
                                    <div className="mt-6 flex flex-col gap-1 cursor-pointer">
                                        {events.map((evt, idx) => (
                                            <div key={idx} onClick={() => evt.type === 'contract' && onEventClick(evt.data)} className={`${evt.color} text-white text-[10px] px-1 rounded truncate`} title={evt.title}>
                                                {evt.title}
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                    <div className="mt-4 flex gap-4 text-xs text-slate-400">
                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-blue-600 rounded"></div> Locação (Clique para detalhes)</div>
                        <div className="flex items-center gap-2"><div className="w-3 h-3 bg-red-600 rounded"></div> Manutenção</div>
                    </div>
                </Card>
            );
        };

        const ContractsView = ({ contracts, contractTemplate }) => (
            <Card className="animate-fade-in">
                <h2 className="text-xl font-bold mb-4 text-blue-400">Listagem de Contratos</h2>
                <div className="overflow-x-auto rounded border border-slate-700">
                    <table className="w-full text-sm text-left text-slate-300">
                        <thead className="text-xs text-slate-400 uppercase bg-slate-900">
                            <tr>
                                <th className="px-4 py-3">Contrato</th>
                                <th className="px-4 py-3">Destino</th>
                                <th className="px-4 py-3">Período</th>
                                <th className="px-4 py-3">Ações</th>
                            </tr>
                        </thead>
                        <tbody className="divide-y divide-slate-700">
                            {contracts.filter(c => c.status !== 'cancelled').map(c => (
                                <tr key={c.id} className="bg-slate-800 hover:bg-slate-700">
                                    <td className="px-4 py-3 font-medium text-white">{c.contractId}<br/><span className="text-xs text-slate-500">{c.clientName}</span></td>
                                    <td className="px-4 py-3">{c.destination}</td>
                                    <td className="px-4 py-3">{formatDate(c.startDate)} <br/> {formatDate(c.endDate)}</td>
                                    <td className="px-4 py-3">
                                        <Button variant="secondary" className="text-xs py-1 px-2" onClick={() => generateContractPDF(c, contractTemplate)}>
                                            <Icon name="printer" className="w-4 h-4" />
                                        </Button>
                                    </td>
                                </tr>
                            ))}
                        </tbody>
                    </table>
                </div>
            </Card>
        );

        const FinanceView = ({ contracts, updatePaymentStatus, loadingId, confirmId }) => {
            // Only Active contracts in finance summary
            const activeContracts = contracts.filter(c => c.status !== 'cancelled');
            const totalRecebido = activeContracts.reduce((acc, c) => {
                let sum = acc;
                if(c.statusSignal === 'paid') sum += (parseFloat(c.signalValue) || 0);
                if(c.statusRemaining === 'paid') sum += (parseFloat(c.remainingValue) || 0);
                return sum;
            }, 0);

            return (
                <div className="space-y-6 animate-fade-in">
                    <Card className="bg-emerald-900/30 border-emerald-800/50 text-center">
                        <h3 className="text-emerald-400 font-bold uppercase text-xs">Caixa Total</h3>
                        <p className="text-3xl font-bold text-white font-mono">{formatMoney(totalRecebido)}</p>
                    </Card>
                    <div className="space-y-4">
                        {activeContracts.map(c => (
                            <Card key={c.id} className="p-4 flex flex-col gap-3">
                                <div className="flex justify-between border-b border-slate-700 pb-2">
                                    <span className="font-bold text-white">{c.contractId} - {c.clientName}</span>
                                    <span className="text-slate-400">{c.destination}</span>
                                </div>
                                <div className="grid grid-cols-2 gap-4">
                                    <div>
                                        <p className="text-xs text-slate-500">Sinal ({formatMoney(c.signalValue)})</p>
                                        <div className="mt-1">
                                            {c.statusSignal === 'paid' ? (
                                                <span className="text-emerald-400 text-sm flex items-center gap-1"><Icon name="check-circle" className="w-4 h-4"/> Pago 
                                                <button onClick={() => generateReceiptPDF(c, 'signal', c.signalValue)} className="ml-2 text-white hover:text-blue-400"><Icon name="printer" className="w-4 h-4"/></button></span>
                                            ) : (
                                                <Button variant={confirmId === `${c.id}_statusSignal` ? "warning" : "primary"} className="py-1 text-xs w-full" disabled={loadingId === c.id} onClick={() => updatePaymentStatus(c.id, 'statusSignal', 'paid')}>
                                                    {loadingId === c.id ? "..." : (confirmId === `${c.id}_statusSignal` ? "Confirmar?" : "Receber")}
                                                </Button>
                                            )}
                                        </div>
                                    </div>
                                    <div>
                                        <p className="text-xs text-slate-500">Restante ({formatMoney(c.remainingValue)})</p>
                                        <p className="text-[10px] text-red-400">{c.dueRestDate ? formatDate(c.dueRestDate) : ''}</p>
                                        <div className="mt-1">
                                            {c.statusRemaining === 'paid' ? (
                                                <span className="text-emerald-400 text-sm flex items-center gap-1"><Icon name="check-circle" className="w-4 h-4"/> Pago
                                                <button onClick={() => generateReceiptPDF(c, 'remaining', c.remainingValue)} className="ml-2 text-white hover:text-blue-400"><Icon name="printer" className="w-4 h-4"/></button></span>
                                            ) : (
                                                <Button variant={confirmId === `${c.id}_statusRemaining` ? "warning" : "primary"} className="py-1 text-xs w-full" disabled={loadingId === c.id} onClick={() => updatePaymentStatus(c.id, 'statusRemaining', 'paid')}>
                                                    {loadingId === c.id ? "..." : (confirmId === `${c.id}_statusRemaining` ? "Confirmar?" : "Receber")}
                                                </Button>
                                            )}
                                        </div>
                                    </div>
                                </div>
                            </Card>
                        ))}
                    </div>
                </div>
            );
        };
        
        const SettingsView = ({ contractTemplate, setContractTemplate, configSignal, setConfigSignal, saveConfig, loading }) => (
            <Card className="animate-fade-in space-y-6">
                <div>
                    <h2 className="text-xl font-bold mb-4 text-blue-400">Configurações Gerais</h2>
                    <Input label="Porcentagem Padrão do Sinal (%)" type="number" value={configSignal} onChange={e => setConfigSignal(e.target.value)} />
                    <Button onClick={saveConfig} className="w-full md:w-auto" disabled={loading}>{loading ? "..." : "Salvar Configuração"}</Button>
                </div>
                <div className="border-t border-slate-700 pt-6">
                    <h2 className="text-xl font-bold mb-4 text-blue-400">Modelo de Contrato</h2>
                    <p className="text-sm text-slate-400 mb-2">Variáveis: {'{{NOME}}'}, {'{{CPF}}'}, {'{{DESTINO}}'}, {'{{DATA_IDA}}'}, {'{{VALOR_TOTAL}}'}, {'{{SINAL}}'}.</p>
                    <textarea className="w-full h-48 p-4 bg-slate-900 border border-slate-600 text-slate-200 rounded font-mono text-sm focus:ring-2 focus:ring-blue-500 focus:outline-none" value={contractTemplate} onChange={(e) => setContractTemplate(e.target.value)} />
                </div>
            </Card>
        );

        // --- APP PRINCIPAL ---
        const App = () => {
            const [user, setUser] = useState(null);
            const [view, setView] = useState("login");
            const [contracts, setContracts] = useState([]);
            const [maintenances, setMaintenances] = useState([]);
            const [loading, setLoading] = useState(false);
            const [loadingId, setLoadingId] = useState(null);
            const [confirmId, setConfirmId] = useState(null);
            const [msg, setMsg] = useState({ type: '', text: '' });
            const [configSignal, setConfigSignal] = useState(20);
            
            const [selectedContract, setSelectedContract] = useState(null); // Para o Modal

            const [newContract, setNewContract] = useState({
                clientName: "", clientCpf: "", origin: "", destination: "",
                startDate: "", endDate: "", totalValue: 0, signalValue: 0, remainingValue: 0,
                dueSignalDate: "", dueRestDate: ""
            });

            const [contractTemplate, setContractTemplate] = useState("Eu, {{NOME}}...");

            useEffect(() => {
                if (!window.firebaseData.auth) return;
                const unsub = window.firebaseData.onAuthStateChanged(window.firebaseData.auth, (u) => {
                    setUser(u);
                    if (u) setView("home"); else setView("login");
                });
                return () => unsub();
            }, []);

            useEffect(() => { if (user) fetchData(); }, [user]);

            const fetchData = async () => {
                if (!window.firebaseData.db) return;
                try {
                    const qC = window.firebaseData.query(window.firebaseData.collection(window.firebaseData.db, "contracts"), window.firebaseData.orderBy("createdAt", "desc"));
                    const snapC = await window.firebaseData.getDocs(qC);
                    setContracts(snapC.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                    const qM = window.firebaseData.query(window.firebaseData.collection(window.firebaseData.db, "maintenances"), window.firebaseData.orderBy("startDate", "asc"));
                    const snapM = await window.firebaseData.getDocs(qM);
                    setMaintenances(snapM.docs.map(doc => ({ id: doc.id, ...doc.data() })));

                    const docConfig = await window.firebaseData.getDoc(window.firebaseData.doc(window.firebaseData.db, "settings", "general"));
                    if (docConfig.exists()) {
                        setConfigSignal(docConfig.data().signalPercent || 20);
                        if(docConfig.data().template) setContractTemplate(docConfig.data().template);
                    }
                } catch (error) { console.error("Erro fetch:", error); }
            };

            const saveConfig = async () => {
                setLoading(true);
                try {
                    await window.firebaseData.setDoc(window.firebaseData.doc(window.firebaseData.db, "settings", "general"), { signalPercent: configSignal, template: contractTemplate });
                    showMsg("success", "Configurações salvas!");
                } catch(e) { console.error(e); showMsg("error", "Erro ao salvar."); }
                setLoading(false);
            }

            const showMsg = (type, text) => { setMsg({ type, text }); setTimeout(() => setMsg({ type: '', text: '' }), 4000); };

            const handleLogin = async (e) => {
                e.preventDefault();
                setLoading(true);
                try {
                    // CONFIGURAÇÃO DE PERSISTÊNCIA 
                    await window.firebaseData.setPersistence(window.firebaseData.auth, window.firebaseData.browserLocalPersistence);
                    await window.firebaseData.signInWithEmailAndPassword(window.firebaseData.auth, e.target.email.value, e.target.password.value);
                } catch (error) { showMsg("error", "Erro no login. Verifique dados."); }
                setLoading(false);
            };

            const handleCreateContract = async (e) => {
                e.preventDefault();
                setLoading(true);
                const now = new Date();
                const contractId = `${Math.floor(1000 + Math.random() * 9000)}/${now.getFullYear()}`;
                const contractData = { ...newContract, contractId, createdAt: new Date().toISOString(), statusSignal: 'pending', statusRemaining: 'pending', status: 'active' };
                try {
                    await window.firebaseData.addDoc(window.firebaseData.collection(window.firebaseData.db, "contracts"), contractData);
                    showMsg("success", `Contrato ${contractId} criado!`);
                    fetchData(); setView("contracts");
                    setNewContract({ clientName: "", clientCpf: "", origin: "", destination: "", startDate: "", endDate: "", totalValue: 0, signalValue: 0, remainingValue: 0, dueSignalDate: "", dueRestDate: "" });
                } catch (error) { showMsg("error", "Erro ao salvar."); }
                setLoading(false);
            };

            const handleCreateMaintenance = async (maint) => {
                setLoading(true);
                try {
                    await window.firebaseData.addDoc(window.firebaseData.collection(window.firebaseData.db, "maintenances"), maint);
                    showMsg("success", "Manutenção agendada."); fetchData();
                } catch(e) { showMsg("error", "Erro ao agendar."); }
                setLoading(false);
            };

            const deleteMaintenance = async (id) => {
                if(!confirm("Remover manutenção?")) return;
                try { await window.firebaseData.deleteDoc(window.firebaseData.doc(window.firebaseData.db, "maintenances", id)); fetchData(); } catch(e) { showMsg("error", "Erro ao remover."); }
            };

            const updatePaymentStatus = async (id, field, value) => {
                const uniqueKey = `${id}_${field}`;
                if (confirmId !== uniqueKey) { setConfirmId(uniqueKey); setTimeout(() => setConfirmId(null), 5000); return; }
                setLoadingId(id);
                try {
                    await window.firebaseData.updateDoc(window.firebaseData.doc(window.firebaseData.db, "contracts", id), { [field]: value });
                    fetchData(); showMsg("success", "Pago!");
                } catch (err) { showMsg("error", "Erro ao atualizar."); }
                setLoadingId(null); setConfirmId(null);
            };

            const handleCancelContract = async (id) => {
                if(!confirm("Deseja realmente CANCELAR este contrato? Isso liberará a data.")) return;
                try {
                    await window.firebaseData.updateDoc(window.firebaseData.doc(window.firebaseData.db, "contracts", id), { status: 'cancelled' });
                    showMsg("success", "Contrato cancelado.");
                    setSelectedContract(null); // Fecha o modal
                    fetchData();
                } catch(e) { showMsg("error", "Erro ao cancelar."); }
            };

            const handleLogout = () => window.firebaseData.signOut(window.firebaseData.auth);

            if (!user) {
                return (
                    <div className="min-h-screen flex items-center justify-center bg-[#0f172a] p-4">
                        <Card className="w-full max-w-md border-slate-700 bg-slate-800">
                            <h1 className="text-3xl font-bold text-center text-blue-400 mb-2">LVD Turismo</h1>
                            <form onSubmit={handleLogin} className="space-y-4 mt-6">
                                <Input name="email" label="E-mail" required />
                                <Input name="password" label="Senha" type="password" required />
                                <Button className="w-full shadow-blue-900/50" disabled={loading}>{loading ? "..." : "Entrar"}</Button>
                            </form>
                            {msg.text && <div className="mt-4 p-2 text-center rounded text-red-300 bg-red-900/50 border border-red-800">{msg.text}</div>}
                        </Card>
                    </div>
                );
            }

            return (
                <div className="flex min-h-screen bg-[#0f172a]">
                    <Sidebar view={view} setView={setView} handleLogout={handleLogout} />
                    <div className="flex-1 ml-20 md:ml-64 p-4 md:p-8 overflow-y-auto">
                        <div className="mb-8 flex justify-between items-center border-b border-slate-800 pb-4">
                            <h1 className="text-2xl md:text-3xl font-bold text-white tracking-tight capitalize">
                                {view === 'home' ? 'Olá, Admin' : view}
                            </h1>
                            <div className="hidden md:flex text-sm text-slate-400 bg-slate-800 px-3 py-1 rounded-full border border-slate-700 items-center gap-2">
                                <div className="w-2 h-2 rounded-full bg-emerald-500"></div> {user.email}
                            </div>
                        </div>

                        {msg.text && ( <div className={`mb-4 p-4 rounded text-white shadow-xl fixed top-5 right-5 z-50 flex items-center gap-2 animate-bounce-in ${msg.type === 'error' ? 'bg-red-600' : 'bg-emerald-600'}`}><span>{msg.text}</span></div> )}

                        {view === 'home' && <HomeView setView={setView} />}
                        {view === 'dashboard' && <DashboardView contracts={contracts} />}
                        {view === 'new_contract' && <NewContractView newContract={newContract} setNewContract={setNewContract} handleCreateContract={handleCreateContract} loading={loading} configSignal={configSignal} />}
                        {view === 'contracts' && <ContractsView contracts={contracts} contractTemplate={contractTemplate} />}
                        {view === 'finance' && <FinanceView contracts={contracts} updatePaymentStatus={updatePaymentStatus} loadingId={loadingId} confirmId={confirmId} />}
                        {view === 'calendar' && <CalendarView contracts={contracts} maintenances={maintenances} onEventClick={setSelectedContract} />}
                        {view === 'maintenance' && <MaintenanceView maintenances={maintenances} handleCreateMaintenance={handleCreateMaintenance} deleteMaintenance={deleteMaintenance} loading={loading} />}
                        {view === 'settings' && <SettingsView contractTemplate={contractTemplate} setContractTemplate={setContractTemplate} configSignal={configSignal} setConfigSignal={setConfigSignal} saveConfig={saveConfig} loading={loading} />}
                        
                        {/* MODAL DE DETALHES */}
                        <ContractDetailsModal contract={selectedContract} onClose={() => setSelectedContract(null)} onCancel={handleCancelContract} />
                    </div>
                </div>
            );
        };

        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>